#!/bin/bash

PLATFORM="$(uname)"
if [[ -z "$HOSTNAME" ]]; then
    HOSTNAME=$(hostname -s)-$RANDOM
fi

if [[ -z "$WEBMUX_HOST" ]]; then
    WEBMUX_HOST="webmux.e.ip.saba.us"
fi
if [[ -z "$WEBMUX_SSH_KEY_FILE" ]]; then
    WEBMUX_SSH_KEY_FILE="~/etc/secure/ssh/external/webmux_rsa"
fi

KEYSCAN="|1|5MOtL8p91Mye7t1QHVqWGy3vh4A=|t2HEPsfvD2Qhg2se60DK8HOnGc0= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBDUeo1sjImOIuV3O88JjW1H+H7QXxF1Otkw5eTHPbopjMvof1SykFOuEhIW7csxJN9vS+2Vly3mvHljTIcJcRlQ="
if [[ -z $(grep "$KEYSCAN" ~/.ssh/known_hosts) ]]; then
    echo "$KEYSCAN" >> ~/.ssh/known_hosts
fi

function get_port_mapping()
{
    MOSH_PATH=""
    if [[ -n $(which mosh-server 2>/dev/null) ]]; then
        MOSH_PATH=$(which mosh-server 2>/dev/null)
    fi
    JSON_DATA="{\"user\":\"$USER\", \"hostname\":\"$HOSTNAME\", \"mosh_path\":\"$MOSH_PATH\"}"
    curl -# -H "Content-Type: application/json" -X POST -d "$JSON_DATA" -f -L "https://$WEBMUX_HOST/register"
}

function webmux_reverse_tunnel()
{
    if [[ -n "$(which gtimeout)" ]]; then
        gtimeout 1h $(which ssh) -i "${WEBMUX_SSH_KEY_FILE/#\~/$HOME}" -N -R $1:localhost:22 "webmux@$WEBMUX_HOST"
    else
        timeout 1h $(which ssh) -i "${WEBMUX_SSH_KEY_FILE/#\~/$HOME}" -N -R $1:localhost:22 "webmux@$WEBMUX_HOST"
    fi
}

if [[ -z "$(which timeout)" ]] && [[ -z "$(which gtimeout)" ]]; then
    if [[ "$PLATFORM" == "Darwin" ]]; then
        brew install coreutils
    elif [[ -n "$(which apt-get)" ]]; then
        sudo apt-get install coreutils
    elif [[ -n "$(which yum)" ]]; then
        sudo yum install coreutils
    else
        echo "ERROR: timeout not found, and I don't know how to install it!"
    fi
fi

if [[ "$PLATFORM" == "Darwin" ]] && [[ -z "$(which reattach-to-user-namespace)" ]]; then
    brew install reattach-to-user-namespace
fi

while [ true ]; do
    PORT_NUMBER=$(get_port_mapping)
    if [[ -z "$PORT_NUMBER" ]]; then
        echo "ERROR: Could not get port mapping; git pull'ing and trying again..."
        git pull
        sleep 10
        exec "./webmux_client"
    fi
    echo "Connecting on port $PORT_NUMBER..."
    webmux_reverse_tunnel $PORT_NUMBER
    sleep 1
done
