#!/bin/bash

if [[ -z "$HOSTNAME" ]]; then
    HOSTNAME=$(hostname -s)-$RANDOM
fi

if [[ -z "$WEBMUX_HOST" ]]; then
    WEBMUX_HOST="webmux.e.ip.saba.us"
fi
if [[ -z "$WEBMUX_SSH_KEY_FILE" ]]; then
    WEBMUX_SSH_KEY_FILE="~/etc/secure/ssh/external/webmux_rsa"
fi

if [[ -z $(grep "webmux.e.ip.saba.us ssh-rsa" ~/.ssh/known_hosts) ]]; then
    echo "webmux.e.ip.saba.us ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCt8svKMVY5PoOJHzJZw6MUTCETWHWrVfKpj5b8McDMSIUiDjrINf7Bntx86G4aocIkWLHD71ZmgdhZACrK9FEJ67ULv3CV0YmFNIYj60e451yXhtXhyearBWD4ry4dd8H/iENTs19r1yzJ102r3g6ztd67JLU7o7g8rZyGUNvd0Ve9ckIpbW6TquZtFhcaQZeG7lQnwJkEDaYFQa1T8GjSdY6SWzzdbHjQr1R+Y/JyR8jnhCkWHXwdw+4d+FWABoAwHbD/9OP2r/upI35d6qEWYKnEQDQcSQss1LiRwl4J033gxXSLpLWk03jxPBguiKEgs0sR/Ukzh9QW2DnffUSn" >> ~/.ssh/known_hosts
fi

if [[ -z "$(which timeout)" ]] && [[ -z "$(which gtimeout)" ]]; then
    if [[ "$PLATFORM" == "Darwin" ]]; then
        brew install coreutils
    elif [[ -n "$(which apt-get)" ]]; then
        sudo apt-get install coreutils
    elif [[ -n "$(which yum)" ]]; then
        sudo yum install coreutils
    else
        echo "ERROR: timeout not found, and I don't know how to install it!"
    fi
fi

function get_port_mapping()
{
    curl -f -L "https://$WEBMUX_HOST/register/$HOSTNAME/$USER" 2>/dev/null
}

function webmux_reverse_tunnel()
{
    if [[ -n "$(which gtimeout)" ]]; then
        gtimeout 1h $(which ssh) -i "$WEBMUX_SSH_KEY_FILE" -N -R $1:localhost:22 "webmux@$WEBMUX_HOST"
    else
        timeout 1h $(which ssh) -i "$WEBMUX_SSH_KEY_FILE" -N -R $1:localhost:22 "webmux@$WEBMUX_HOST"
    fi
}

while [ true ]; do
    PORT_NUMBER=$(get_port_mapping)
    if [[ -z "$PORT_NUMBER" ]]; then
        if (( "$PORT_MAP_FAILURES" < 10 )); then
            echo "ERROR: Could not get port mapping; Sleeping for $((PORT_MAP_FAILURES*10)), then trying again (try $PORT_MAP_FAILURES)"
            sleep $((PORT_MAP_FAILURES*10))
            continue
        fi
        echo "ERROR: Could not get port mapping; bailing after $PORT_MAP_FAILURES tries!"
        exit 1
    fi
    echo "Connecting on port $PORT_NUMBER..."
    webmux_reverse_tunnel $PORT_NUMBER
    sleep 1
done
